import asyncio
import sqlite3

from telethon import Button, events

import database
from config import *


def connect_db():
    return sqlite3.connect("Gift.db")

@bot.on(events.NewMessage(pattern=r"^/admin$"))
async def admin_panel(event):
    if event.sender_id != admin_id:
        return
    
    buttons = [
        [Button.inline("ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡", b"manage_bans")],
        [Button.inline("ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ", b"send_broadcast")],
        [Button.inline("Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±", b"message_fast")],
        [Button.inline("Ù„ÛŒØ³Øª Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†", b"all_list")]
    ]
    await event.reply("ğŸ”§Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª :", buttons=buttons)

@bot.on(events.CallbackQuery(data=b"manage_bans"))
async def manage_bans(event):
    buttons = [
        [Button.inline("ğŸ‘€ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡", b"list_banned")],
        [Button.inline("â• Ø¨Ù† Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±", b"ban_user")],
        [Button.inline("â• Ø¢Ù†Ø¨Ù† Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±", b"unban_user")],
        [Button.inline("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", b"admin_panel")]
    ]
    await event.edit("ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡:", buttons=buttons)

@bot.on(events.CallbackQuery(data=b"message_fast"))
async def send_custom_message(event):

    async with bot.conversation(event.sender_id) as conv:
        try:
            await conv.send_message("ğŸ“Œ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
            user_id_msg = await conv.get_response(timeout=3600)
            
            if not user_id_msg.text.isdigit():
                return await conv.send_message("âš ï¸ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
            
            user_id = int(user_id_msg.text)

            await conv.send_message("âœ‰ï¸ Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù…ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯:")
            message_text = await conv.get_response(timeout=3600)

            await bot.send_message(user_id, f"ğŸ“© Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:\n\n{message_text.text}")
            await conv.send_message("âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
            await event.reply("âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

@bot.on(events.CallbackQuery(data=b"admin_panel"))
async def admin_panel_again(event):
    await event.answer()
    await event.delete()
    await admin_panel(event)

@bot.on(events.CallbackQuery(data=b"list_banned"))
async def list_banned(event):
    conn = connect_db()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM banned_users")
    banned_users = cursor.fetchall()
    conn.close()
    
    if not banned_users:
        await event.answer("âŒ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!", alert=True)
        return
    
    message = "ğŸš« **Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡:**\n\n"
    for index, user in enumerate(banned_users, start=1):
        message += f"{index}. ğŸ‘¤ User ID: `{user[0]}`\n"
    
    await event.answer()
    await event.respond(message)

@bot.on(events.CallbackQuery(data=b"ban_user"))
async def ban_user(event):
    await event.answer()
    async with bot.conversation(event.sender_id) as conv:
        await conv.send_message("Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ù† Ú©Ø±Ø¯Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        user_id = await conv.get_response(timeout=3600)
        
        if not user_id.text.isdigit():
            await conv.send_message("âŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
            return
        
        conn = connect_db()
        cursor = conn.cursor()
        cursor.execute("INSERT OR IGNORE INTO banned_users (user_id) VALUES (?)", (int(user_id.text),))
        conn.commit()
        conn.close()
        
        await conv.send_message(f"âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ `{user_id.text}` Ø¨Ù† Ø´Ø¯!")

@bot.on(events.CallbackQuery(data=b"unban_user"))
async def unban_user(event):
    await event.answer()
    async with bot.conversation(event.sender_id) as conv:
        await conv.send_message("Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¢Ù†Ø¨Ù† Ú©Ø±Ø¯Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        user_id = await conv.get_response(timeout=3600)
        
        if not user_id.text.isdigit():
            await conv.send_message("âŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
            return
        
        conn = connect_db()
        cursor = conn.cursor()
        cursor.execute("DELETE FROM banned_users WHERE user_id = ?", (int(user_id.text),))
        conn.commit()
        conn.close()
        
        await conv.send_message(f"âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ `{user_id.text}` Ø¢Ù†Ø¨Ù† Ø´Ø¯!")

@bot.on(events.CallbackQuery(data=b"send_broadcast"))
async def send_broadcast(event):
    async with bot.conversation(event.sender_id) as conv:
        await conv.send_message("ğŸ“¢ Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        message = await conv.get_response(timeout=3600)
        
        conn = connect_db()
        cursor = conn.cursor()
        cursor.execute("SELECT user_id FROM users WHERE user_id NOT IN (SELECT user_id FROM banned_users)")
        users = cursor.fetchall()
        conn.close()
        
        for user in users:
            try:
                await bot.send_message(user[0], message.text)
            except:
                pass
        
        await conv.send_message("âœ… Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!")

@bot.on(events.CallbackQuery(data=b"all_list"))
async def show_all_users(event):
    users = database.get_all_users()
    if not users:
        await event.answer("âŒ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!", alert=True)
        return

    messages = []
    message = "ğŸ“‹ **Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**\n\n"

    for index, user in enumerate(users, start=1):
        line = f"{index}. ğŸ‘¤ **ID:** `{user[0]}`\n"

        if message.count("\n") < 25: 
            message += line
        else: 
            messages.append(message)
            message = line

    if message: 
        messages.append(message)

    for msg in messages: 
        await event.respond(msg)
